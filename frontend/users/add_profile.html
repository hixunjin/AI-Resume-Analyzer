<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修改个人信息</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: "Segoe UI", Arial, sans-serif;
            background-color: #f7f8fa;
        }

        .container {
            max-width: 600px;
            margin-top: 50px;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: #007bff;
            text-align: center;
            margin-bottom: 30px;
        }

        .form-label {
            color: #333;
            font-weight: bold;
        }

        .form-control {
            border-radius: 5px;
            border-color: #ced4da;
            transition: border-color 0.3s ease-in-out;
        }

        .form-control:focus {
            border-color: #007bff;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
        }

        .btn-primary {
            width: 100%;
            background-color: #007bff;
            border: none;
            padding: 12px;
            border-radius: 5px;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .loading-spinner {
            display: none;
            margin-top: 20px;
            text-align: center;
        }

        .loading-spinner span {
            color: #007bff;
            font-size: 18px;
        }

        .alert {
            margin-top: 20px;
            display: none;
        }

        /* 小屏幕优化 */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <h2>修改个人信息</h2>

        <!-- 提交成功或失败提示 -->
        <div id="alert" class="alert alert-success" role="alert">
            个人信息更新成功！
        </div>
        <div id="alert-error" class="alert alert-danger" role="alert">
            更新失败，请稍后重试。
        </div>

        <!-- 个人信息表单 -->
        <form id="profileForm">
            <div class="mb-3">
                <label for="school" class="form-label">毕业院校</label>
                <input type="text" class="form-control" id="school" required>
            </div>

            <div class="mb-3">
                <label for="major" class="form-label">学习专业</label>
                <input type="text" class="form-control" id="major" required>
            </div>

            <div class="mb-3">
                <label for="expected_job" class="form-label">期望岗位</label>
                <input type="text" class="form-control" id="expected_job" required>
            </div>

            <div class="mb-3">
                <label for="expected_salary" class="form-label">期望薪资</label>
                <input type="text" class="form-control" id="expected_salary" required>
            </div>

            <div class="mb-3">
                <label for="expected_city" class="form-label">期望城市</label>
                <input type="text" class="form-control" id="expected_city" required>
            </div>

            <div class="mb-3">
                <label for="current_address" class="form-label">当前住址</label>
                <input type="text" class="form-control" id="current_address" required>
            </div>

            <button type="submit" class="btn btn-primary">提交</button>

            <!-- 加载提示 -->
            <div class="loading-spinner">
                <span>正在更新个人信息，请稍候...</span>
            </div>
        </form>
    </div>

    <script>
        // 从本地存储获取JWT token
        const accessToken = localStorage.getItem('accessToken');  // 假设token保存在localStorage中

        // 检查是否有token
        if (!accessToken) {
            alert("请先登录！");
            window.location.href = 'login.html'; // 如果没有token，则跳转到登录页面
        }

        // 获取用户详细信息以预填充表单
        fetch('http://127.0.0.1:8000/api/users/profile/full/', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${accessToken}`,  // 将token作为Authorization头部传递
            }
        })
        .then(response => response.json())
        .then(data => {
            // 填充表单，填充个人信息
            document.getElementById('school').value = data.profile.school || '';
            document.getElementById('major').value = data.profile.major || '';
            document.getElementById('expected_job').value = data.profile.expected_job || '';
            document.getElementById('expected_salary').value = data.profile.expected_salary || '';
            document.getElementById('expected_city').value = data.profile.expected_city || '';
            document.getElementById('current_address').value = data.profile.current_address || '';
        })
        .catch(error => {
            console.error('Error fetching profile data:', error);
        });

        // 提交表单，更新个人信息
        document.getElementById('profileForm').onsubmit = function(event) {
            event.preventDefault();

            const profileData = {
                school: document.getElementById('school').value,
                major: document.getElementById('major').value,
                expected_job: document.getElementById('expected_job').value,
                expected_salary: document.getElementById('expected_salary').value,
                expected_city: document.getElementById('expected_city').value,
                current_address: document.getElementById('current_address').value,
            };

            // 显示加载提示
            document.querySelector('.loading-spinner').style.display = 'block';

            fetch('http://127.0.0.1:8000/api/users/api/profile/', {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,  // 将token作为Authorization头部传递
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(profileData),
            })
            .then(response => response.json())
            .then(data => {
                // 隐藏加载提示
                document.querySelector('.loading-spinner').style.display = 'none';

                // 显示成功提示
                document.getElementById('alert').style.display = 'block';
                setTimeout(() => {
                    window.location.href = 'user.html';  // 更新后跳转到个人中心页面
                }, 2000);
            })
            .catch(error => {
                // 隐藏加载提示
                document.querySelector('.loading-spinner').style.display = 'none';

                // 显示失败提示
                document.getElementById('alert-error').style.display = 'block';
                console.error('Error updating profile:', error);
            });
        };
    </script>
</body>
</html>
